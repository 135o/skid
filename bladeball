RunService.PreSimulation:Connect(function(dt)
    local ball = findBall()
    local hrp = localPlayer.Character and localPlayer.Character:FindFirstChild("HumanoidRootPart")
    if not ball or not hrp then return end

    local velocity = ball.zoomies.VectorVelocity
    local speed = velocity.Magnitude
    local currentPosition = ball.Position
    local acceleration = ball.AssemblyLinearVelocity - velocity

    -- Calculate dynamic lookahead time based on speed and distance
    local distanceToPlayer = (currentPosition - hrp.Position).Magnitude
    local lookaheadTime = math.clamp(distanceToPlayer / (speed + 10), 0.2, 0.5)  -- Calculate time based on distance and speed

    -- Predicted position using a more refined prediction
    local predictedPosition = currentPosition + (velocity * lookaheadTime) + (0.5 * acceleration * lookaheadTime ^ 2)
    local predictedDistance = (predictedPosition - hrp.Position).Magnitude

    -- Dynamic parry range based on speed and distance
    local parryRange = math.clamp(speed * 0.75, 10, 150)  -- Adjust parry range based on speed (more dynamic)

    -- Visualize the parry range
    debugSphere.Position = hrp.Position
    debugSphere.Size = Vector3.new(parryRange * 2, parryRange * 2, parryRange * 2)

    local targetName = ball:GetAttribute("target")

    -- Update UI labels
    labels.Velocity.Text = "Velocity: " .. string.format("%.0f", speed)
    labels.Scale.Text = "Scale: " .. string.format("%.0f", parryRange)
    labels.Distance.Text = "Distance: " .. string.format("%.0f", predictedDistance)
    labels.BallPos.Text = "BallPos: " .. formatVector3(currentPosition)
    labels.PlayerPos.Text = "PlayerPos: " .. formatVector3(hrp.Position)
    labels.Target.Text = "Target: " .. (targetName or "N/A")

    -- Check if the ball is within parry range and attempt to parry if the target is the player
    if targetName == localPlayer.Name and not isParried and predictedDistance <= parryRange then
        VirtualInputManager:SendMouseButtonEvent(0,0, 0, true, game, 0)
        VirtualInputManager:SendMouseButtonEvent(0,0, 0, false, game, 0)
        isParried = true
    end
end)
